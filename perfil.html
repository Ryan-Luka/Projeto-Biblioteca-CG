<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Perfil do UsuÃ¡rio - Biblioteca Municipal de Campina Grande</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    #listaEmprestimos, #listaReservasUsuario {
      display: flex;
      flex-direction: column;
      gap: 15px;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    #listaEmprestimos li, #listaReservasUsuario li {
      margin: 0;
      padding: 15px;
      border: none;
      background-color: #e8e8e8;
      border-radius: 8px;
      transition: background-color 0.3s, transform 0.2s;
    }
    
    #listaEmprestimos li:hover, #listaReservasUsuario li:hover {
      background-color: #d9d9d9;
      transform: translateY(-2px);
    }
    
    .livro-item {
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }

    .livro-capa {
      flex-shrink: 0;
      min-width: 80px;
    }

    .capa-imagem {
      width: 80px;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      background-color: #ccc;
      display: block;
    }

    .livro-info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .livro-info strong {
      font-size: 16px;
      color: #333;
      margin-bottom: 4px;
    }

    .livro-info .autor {
      margin: 2px 0;
      color: #555;
      font-size: 14px;
    }

    .livro-info .detalhes {
      margin: 4px 0 8px 0;
      color: #777;
      font-size: 13px;
    }

    .livro-acoes {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 8px;
    }
    
    .status {
      font-weight: bold;
      padding: 6px 12px;
      border-radius: 20px;
      display: inline-block;
    }

    .status.disponivel {
      background-color: #c8e6c9;
      color: #1b5e20;
    }

    .status.reservado,
    .status.emprestado {
      background-color: #ffe0b2;
      color: #e65100;
    }

    .status.pendente {
      background-color: #f8bbd0;
      color: #c2185b;
    }

    .botao {
      background: #0b3c15;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
    }

    .botao:hover {
      background: #082d0e;
    }

    .botao[disabled] {
      background: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <img src="img/image.png" alt="Logo da Biblioteca" class="logo">
      Biblioteca Municipal de Campina Grande
    </h1>
    <nav id="menu"></nav>
  </header>

  <main>
    <section class="banner">
      <h2>Bem-vindo, <span id="nomeUsuario"></span>!</h2>
      <p>Email cadastrado: <strong id="emailUsuario"></strong></p>
      <br>

      <a href="livros.html" class="botao">ðŸ“š Consultar Livros</a>

      <h3 style="margin-top: 30px;">ðŸ“˜ Meus livros emprestados</h3>
      <ul id="listaEmprestimos"></ul>
      <h3 style="margin-top: 30px;">ðŸ“’ Minhas reservas</h3>
      <ul id="listaReservasUsuario"></ul>
      <p id="msg"></p>
    </section>
  </main>

  <footer>
    <p>Â© 2025 Biblioteca Municipal de Campina Grande</p>
  </footer>

  <script>
    const tipo = localStorage.getItem("tipo");
    const nome = localStorage.getItem("nome");
    const email = localStorage.getItem("email");

    if (tipo !== "usuario" || !nome || !email) {
      alert("Acesso negado! FaÃ§a login primeiro.");
      window.location.href = "login.html";
    }

    document.getElementById("nomeUsuario").textContent = nome;
    document.getElementById("emailUsuario").textContent = email;

    //MENU
    const menu = document.getElementById("menu");
    if (tipo === "usuario") {
      menu.innerHTML = `
        <a href="index.html">InÃ­cio</a>
        <a href="livros.html">Livros</a>
        <a href="contato.html">Contato</a>
        <a href="perfil.html" class="ativo">Meu Perfil</a>
        <a href="#" id="logoutLink">ðŸ‘¤ Sair</a>
      `;
    } else if (tipo === "admin") {
      menu.innerHTML = `
        <a href="index.html">InÃ­cio</a>
        <a href="livros.html">Livros</a>
        <a href="admin.html">Painel Admin</a>
        <a href="reservas_admin.html">Reservas</a>
        <a href="devolucoes_admin.html">DevoluÃ§Ãµes</a>
        <a href="#" id="logoutLink">ðŸ‘¤ Sair</a>
      `;
    } else {
      menu.innerHTML = `
        <a href="index.html">InÃ­cio</a>
        <a href="livros.html">Livros</a>
        <a href="cadastro.html">Cadastro</a>
        <a href="contato.html">Contato</a>
        <a href="login.html" id="loginLink">Login</a>
      `;
    }

    const logoutLink = document.getElementById("logoutLink");
    if (logoutLink) {
      logoutLink.addEventListener("click", () => {
        localStorage.setItem("tipo", "");
        localStorage.setItem("nome", "");
        localStorage.setItem("email", "");
        window.location.href = "index.html";
      });
    }

    //LISTAR EMPRESTIMOS E RESERVAS
let emprestimos = JSON.parse(localStorage.getItem("emprestimos")) || [];
let devolucoes = JSON.parse(localStorage.getItem("devolucoes")) || [];
let reservas = JSON.parse(localStorage.getItem("reservas")) || [];
const listaEmprestimos = document.getElementById("listaEmprestimos");
const listaReservasUsuario = document.getElementById("listaReservasUsuario");

function atualizarEmprestimos() {
  listaEmprestimos.innerHTML = "";

  const meus = emprestimos.filter(e => e.usuario === email);

  if (meus.length === 0) {
    listaEmprestimos.innerHTML = "<p style='color:gray;'>VocÃª nÃ£o possui livros emprestados.</p>";
    return;
  }

  meus.forEach((emp, index) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="livro-item">
        <div class="livro-capa">
          <img src="img/capa-padrao.png" alt="Capa de ${emp.livro}" class="capa-imagem">
        </div>
        <div class="livro-info">
          <strong>${emp.livro}</strong>
          <p class="detalhes">Status: <span class="status emprestado">EMPRESTADO</span></p>
          <div class="livro-acoes">
            <button class="botao" data-index="${index}">Devolver</button>
          </div>
        </div>
      </div>
    `;
    listaEmprestimos.appendChild(li);
  });
}

//LISTAR RESERVAS DO USUÃRIO
function atualizarReservasUsuario() {
  listaReservasUsuario.innerHTML = "";

  const minhas = reservas.filter(r => r.usuario === email);

  if (minhas.length === 0) {
    listaReservasUsuario.innerHTML = "<p style='color:gray;'>VocÃª nÃ£o possui reservas.</p>";
    return;
  }

  minhas.forEach((r, idx) => {
    const li = document.createElement("li");

    // determinar status do livro
    let statusLivro = "disponivel";
    if (emprestimos.some(emp => emp.livro === r.livro)) {
      statusLivro = "emprestado";
    } else if (reservas.some(rr => rr.livro === r.livro && (rr.status === "pendente" || rr.status === "aprovada"))) {
      statusLivro = "reservado";
    }

    li.innerHTML = `
      <div class="livro-item">
        <div class="livro-capa">
          <img src="img/capa-padrao.png" alt="Capa de ${r.livro}" class="capa-imagem">
        </div>
        <div class="livro-info">
          <strong>${r.livro}</strong>
          <p class="detalhes">Status do livro: <span class="status ${statusLivro}">${statusLivro.toUpperCase()}</span></p>
          <p class="detalhes">Sua reserva: <span class="status ${r.status === 'pendente' ? 'reservado' : 'emprestado'}">${r.status.toUpperCase()}</span></p>
          <div class="livro-acoes">
            ${r.status === 'pendente' ? `<button class="botao" data-index="${idx}">Cancelar Reserva</button>` : ''}
          </div>
        </div>
      </div>
    `;

    listaReservasUsuario.appendChild(li);
  });
}

// permitir cancelar reservas pendentes
listaReservasUsuario.addEventListener("click", e => {
  if (e.target.tagName === 'BUTTON') {
    const i = e.target.getAttribute('data-index');
    const minhas = reservas.filter(r => r.usuario === email);
    const reserva = minhas[i];
    const confirmacao = confirm(`Deseja cancelar a reserva de "${reserva.livro}"?`);
    if (!confirmacao) return;

    // remover a reserva (apenas a primeira correspondÃªncia do usuÃ¡rio/livro)
    const idxGlobal = reservas.findIndex(r => r.usuario === email && r.livro === reserva.livro && r.status === reserva.status);
    if (idxGlobal !== -1) {
      reservas.splice(idxGlobal, 1);
      localStorage.setItem('reservas', JSON.stringify(reservas));
      reservas = JSON.parse(localStorage.getItem('reservas')) || [];
      atualizarReservasUsuario();
      alert('Reserva cancelada.');
    }
  }
});

//ENVIAR SOLICITAÃ‡ÃƒO DE DEVOLUÃ‡ÃƒO
listaEmprestimos.addEventListener("click", e => {
  if (e.target.tagName === "BUTTON") {
    const i = e.target.getAttribute("data-index");
    const emprestimo = emprestimos.filter(e => e.usuario === email)[i];

    devolucoes.push({
      livro: emprestimo.livro,
      usuario: emprestimo.usuario,
      status: "pendente"
    });

    localStorage.setItem("devolucoes", JSON.stringify(devolucoes));

    alert("SolicitaÃ§Ã£o de devoluÃ§Ã£o enviada!");
  }
});

atualizarEmprestimos();
atualizarReservasUsuario();

</script>

  
</body>
</html>
